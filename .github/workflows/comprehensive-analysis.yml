name: Comprehensive Code Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 1 * * 1' # Run every Monday at 1 AM

jobs:
  comprehensive-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Shallow clones should be disabled for better analysis
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, dom, fileinfo, mysql, pdo_mysql, zip, gd, curl, xml, bcmath, soap, intl, readline, libxml, openssl, tokenizer, ctype, json, iconv, session, filter, hash, opcache
        coverage: xdebug
    
    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: ~/.composer/cache
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-
    
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-suggest
    
    - name: Run PHPUnit tests
      run: |
        vendor/bin/phpunit --configuration=phpunit.xml --coverage-html=storage/app/coverage/html --coverage-clover=storage/app/coverage/clover.xml --coverage-text=storage/app/coverage/coverage.txt
        
    - name: Run PHPStan analysis
      run: |
        vendor/bin/phpstan analyse --memory-limit=1G --error-format=github --no-progress
        
    - name: Run PHP CodeSniffer
      run: |
        vendor/bin/phpcs --standard=PSR12 --report=checkstyle --report-file=phpcs-report.xml app/
        
    - name: Run Laravel Pint
      run: |
        vendor/bin/pint --test
        
    - name: Run Composer Security Check
      run: |
        vendor/bin/security-checker security:check composer.lock
        
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Codacy Quality Check
      uses: codacy/codacy-analysis-cli-action@master
      with:
        codacy-api-token: ${{ secrets.CODACY_PROJECT_TOKEN || 'IJ2F1RZG6BfH3B7FTRdl' }}
        directory: .
        output-format: json
        output-file: codacy-analysis-results.json
        github-token: ${{ secrets.GITHUB_TOKEN }}
        comment-pr: true
        
    - name: Generate comprehensive report
      run: |
        echo "# Comprehensive Code Analysis Report" > comprehensive-report.md
        echo "Generated on: $(date)" >> comprehensive-report.md
        echo "" >> comprehensive-report.md
        echo "## Analysis Summary:" >> comprehensive-report.md
        echo "- ✅ PHPUnit tests executed" >> comprehensive-report.md
        echo "- ✅ PHPStan static analysis completed" >> comprehensive-report.md
        echo "- ✅ PHP CodeSniffer style check completed" >> comprehensive-report.md
        echo "- ✅ Laravel Pint formatting check completed" >> comprehensive-report.md
        echo "- ✅ Security vulnerability scan completed" >> comprehensive-report.md
        echo "- ✅ Codacy quality analysis completed" >> comprehensive-report.md
        echo "" >> comprehensive-report.md
        echo "## Coverage Information:" >> comprehensive-report.md
        if [ -f "storage/app/coverage/coverage.txt" ]; then
          echo "\`\`\`" >> comprehensive-report.md
          cat storage/app/coverage/coverage.txt >> comprehensive-report.md
          echo "\`\`\`" >> comprehensive-report.md
        fi
        
    - name: Upload all reports
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-analysis-reports
        path: |
          storage/app/coverage/
          phpcs-report.xml
          trivy-results.sarif
          codacy-analysis-results.json
          comprehensive-report.md
        retention-days: 30
        
    - name: Comment PR with comprehensive results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          let comment = '## 🔍 Comprehensive Code Analysis Results\n\n';
          
          // Add coverage information
          if (fs.existsSync('storage/app/coverage/coverage.txt')) {
            const coverage = fs.readFileSync('storage/app/coverage/coverage.txt', 'utf8');
            comment += '### 📊 Test Coverage\n';
            comment += '```\n' + coverage + '\n```\n\n';
          }
          
          // Add security scan results
          comment += '### 🔒 Security Analysis\n';
          comment += '- ✅ Trivy vulnerability scan completed\n';
          comment += '- ✅ Composer security check completed\n';
          comment += '- ✅ PHPStan security analysis completed\n\n';
          
          // Add quality analysis results
          comment += '### 🎯 Quality Analysis\n';
          comment += '- ✅ PHPStan static analysis completed\n';
          comment += '- ✅ PHP CodeSniffer style check completed\n';
          comment += '- ✅ Laravel Pint formatting check completed\n';
          comment += '- ✅ Codacy quality analysis completed\n\n';
          
          comment += '### 📋 Next Steps\n';
          comment += 'Please review any issues found and address them before merging.\n';
          comment += 'All reports are available in the workflow artifacts.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
