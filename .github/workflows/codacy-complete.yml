name: Complete Codacy Integration

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 1' # Run every Monday at midnight

jobs:
  complete-codacy-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, dom, fileinfo, mysql, pdo_mysql, zip, gd, curl, xml, bcmath, soap, intl, readline, libxml, openssl, tokenizer, ctype, json, iconv, session, filter, hash, opcache
        coverage: xdebug
    
    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: ~/.composer/cache
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-
    
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-suggest
    
    - name: Run comprehensive tests
      run: |
        vendor/bin/phpunit --configuration=phpunit.xml --coverage-html=storage/app/coverage/html --coverage-clover=storage/app/coverage/clover.xml --coverage-text=storage/app/coverage/coverage.txt
        
    - name: Complete Codacy Analysis
      uses: codacy/codacy-analysis-cli-action@master
      with:
        codacy-api-token: ${{ secrets.CODACY_PROJECT_TOKEN || 'IJ2F1RZG6BfH3B7FTRdl' }}
        directory: .
        tools: phpcs,phpstan,trivy,eslint
        output-format: json
        output-file: complete-codacy-results.json
        github-token: ${{ secrets.GITHUB_TOKEN }}
        comment-pr: true
        fail-build-on-issues: false
        max-issues: 1000
        
    - name: Run all quality checks
      run: |
        # PHPStan analysis
        vendor/bin/phpstan analyse --memory-limit=1G --error-format=github --no-progress --level=8
        
        # PHP CodeSniffer
        vendor/bin/phpcs --standard=PSR12 --report=checkstyle --report-file=phpcs-report.xml app/
        
        # Laravel Pint
        vendor/bin/pint --test
        
        # Security check
        vendor/bin/security-checker security:check composer.lock
        
        # Performance analysis
        echo "Analyzing performance patterns..."
        if grep -r "->get()" --include="*.php" app/ | grep -v "vendor"; then
          echo "⚠️  Potential N+1 queries found"
        fi
        
        if grep -r "foreach.*foreach\|for.*for" --include="*.php" app/ | grep -v "vendor"; then
          echo "⚠️  Nested loops found"
        fi
        
        if grep -r "Cache::\|cache()" --include="*.php" app/ | grep -v "vendor"; then
          echo "Found caching usage in code"
        else
          echo "⚠️  No caching found - consider implementing caching"
        fi
        
    - name: Generate complete report
      run: |
        echo "# Complete Codacy Integration Report" > complete-report.md
        echo "Generated on: $(date)" >> complete-report.md
        echo "" >> complete-report.md
        echo "## Complete Analysis Summary:" >> complete-report.md
        echo "- ✅ PHPUnit tests with coverage" >> complete-report.md
        echo "- ✅ Complete Codacy analysis" >> complete-report.md
        echo "- ✅ PHPStan static analysis" >> complete-report.md
        echo "- ✅ PHP CodeSniffer style check" >> complete-report.md
        echo "- ✅ Laravel Pint formatting" >> complete-report.md
        echo "- ✅ Security vulnerability scan" >> complete-report.md
        echo "- ✅ Performance analysis" >> complete-report.md
        echo "" >> complete-report.md
        echo "## Coverage Information:" >> complete-report.md
        if [ -f "storage/app/coverage/coverage.txt" ]; then
          echo "\`\`\`" >> complete-report.md
          cat storage/app/coverage/coverage.txt >> complete-report.md
          echo "\`\`\`" >> complete-report.md
        fi
        
    - name: Upload complete reports
      uses: actions/upload-artifact@v3
      with:
        name: complete-codacy-reports
        path: |
          storage/app/coverage/
          complete-codacy-results.json
          phpcs-report.xml
          complete-report.md
        retention-days: 30
        
    - name: Comment PR with complete results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          let comment = '## 🔍 Complete Codacy Integration Results\n\n';
          
          // Add coverage information
          if (fs.existsSync('storage/app/coverage/coverage.txt')) {
            const coverage = fs.readFileSync('storage/app/coverage/coverage.txt', 'utf8');
            comment += '### 📊 Test Coverage\n';
            comment += '```\n' + coverage + '\n```\n\n';
          }
          
          // Add Codacy results
          if (fs.existsSync('complete-codacy-results.json')) {
            const codacyResults = JSON.parse(fs.readFileSync('complete-codacy-results.json', 'utf8'));
            comment += '### 🎯 Codacy Quality Analysis\n';
            comment += `- **Total Issues**: ${codacyResults.summary?.totalIssues || 'N/A'}\n`;
            comment += `- **New Issues**: ${codacyResults.summary?.newIssues || 'N/A'}\n`;
            comment += `- **Fixed Issues**: ${codacyResults.summary?.fixedIssues || 'N/A'}\n\n`;
          }
          
          // Add quality checks
          comment += '### ✅ Quality Checks\n';
          comment += '- ✅ PHPStan static analysis completed\n';
          comment += '- ✅ PHP CodeSniffer style check completed\n';
          comment += '- ✅ Laravel Pint formatting check completed\n';
          comment += '- ✅ Security vulnerability scan completed\n';
          comment += '- ✅ Performance analysis completed\n\n';
          
          comment += '### 📋 Next Steps\n';
          comment += 'Please review any issues found and address them before merging.\n';
          comment += 'All reports are available in the workflow artifacts.\n\n';
          comment += '### 🔗 Links\n';
          comment += '- [Codacy Dashboard](https://app.codacy.com)\n';
          comment += '- [GitHub Actions](https://github.com/${{ github.repository }}/actions)\n';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
